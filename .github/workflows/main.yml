name: Deploy Docker Compose

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    environment: test-env

    steps:
    - name: Code checkout
      uses: actions/checkout@v4
    
    - name: Create .env files
      run: |
        mkdir -p env
        echo "DB_HOST=${{ vars.DB_HOST }}" >> env/netbox.env
        echo "DB_NAME=${{ vars.DB_NAME }}" >> env/netbox.env
        echo "DB_USER=${{ vars.DB_USER }}" >> env/netbox.env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> env/netbox.env
        echo "REDIS_CACHE_PASSWORD=${{ secrets.REDIS_CACHE_PASSWORD }}" >> env/netbox.env
        echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> env/netbox.env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> env/netbox.env

        echo "SKIP_SUPERUSER= False" >>env/netbox.env
        echo "SUPERUSER_API_TOKEN=" >> env/netbox.env
        echo "SUPERUSER_EMAIL=" >> env/netbox.env
        echo "SUPERUSER_NAME=${{ vars.SUPERUSER_NAME }}" >> env/netbox.env
        echo "SUPERUSER_PASSWORD=${{ secrets.ROOT_PASSWORD }}" >> env/netbox.env

        echo "POSTGRES_DB=${{ vars.DB_NAME }}" >> env/postgres.env
        echo "POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}" >> env/postgres.env
        echo "POSTGRES_USER=${{ vars.DB_USER }}" >> env/postgres.env

        echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> env/redis-cache.env

        echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> env/redis.env

    
    - name: Stop and delete old containers
      run: |
        docker compose -f docker-compose.yml -f docker-compose.override.yml down --remove-orphans
      continue-on-error: true
    
    - name: Cleanup old images
      run: docker image prune -f
      continue-on-error: true
    
    - name: Build containers
      run: docker compose -f docker-compose.yml -f docker-compose.override.yml build --no-cache

    - name: Run containers
      run: docker compose -f docker-compose.yml -f docker-compose.override.yml up -d
    
    - name: Wait for initialization
      run: |
        echo "Waiting for NetBox to be healthy..."
        timeout 180 bash -c 'until docker compose -f docker-compose.yml -f docker-compose.override.yml ps | grep netbox | grep -q "healthy"; do sleep 5; done' || echo "Timeout waiting for healthy status"
    
    - name: Health check
      run: |
        docker compose -f docker-compose.yml -f docker-compose.override.yml ps
        docker compose -f docker-compose.yml -f docker-compose.override.yml logs --tail=100
    
    - name: Connection test
      run: |
        curl -f http://localhost:8080/health || echo "Health check failed"
      continue-on-error: true
